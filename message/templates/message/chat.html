{% extends "base.html" %}
{% load static %}

{% block head %}
  <title>Chat</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}
  <div class="chat-wrap">
    <div class="chat-panel">
      <div class="chat-header">
        <div style="display:flex;gap:12px;align-items:center">
          <a href="/messages/inbox/" class="back-link">‚Üê Inbox</a>
          <div class="title">{{ other_user.get_full_name|default:other_user.username }}</div>
        </div>
      </div>

      <div id="messages" class="messages" aria-live="polite"></div>

      <form id="chat-form" class="input-row" action="javascript:;">
        <input id="msg-input" name="message" type="text" autocomplete="off" placeholder="Write a message..." />
        <button type="submit" class="send-btn">Send</button>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const conversationId = '{{ conversation_id }}';
  const userId = '{{ request.user.pk }}';

  function addMessage(obj){
    const wrapper = document.createElement('div');
    wrapper.className = 'chat-line';

    const isMe = (obj.sender_id == userId);

    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    if (obj.sender_avatar) {
      const img = document.createElement('img');
      img.src = obj.sender_avatar;
      img.alt = obj.sender_username || 'avatar';
      img.style.width = '40px'; img.style.height = '40px'; img.style.borderRadius = '50%';
      avatar.innerHTML = '';
      avatar.appendChild(img);
    } else {
      avatar.textContent = (obj.sender_username || '?').charAt(0).toUpperCase();
    }

    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (isMe ? 'me' : 'them');
    bubble.innerHTML = `<div style="font-size:13px;font-weight:700;margin-bottom:6px;">${obj.sender_username || ''}</div><div>${obj.content}</div><div class="msg-meta">${new Date(obj.created_at).toLocaleTimeString()}</div>`;

    const line = document.createElement('div');
    line.style.display = 'flex';
    line.style.alignItems = 'flex-start';
    line.style.gap = '10px';
    if (isMe) {
      line.style.justifyContent = 'flex-end';
      line.appendChild(bubble);
      line.appendChild(avatar);
    } else {
      line.appendChild(avatar);
      line.appendChild(bubble);
    }

    document.getElementById('messages').appendChild(line);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
  }

  // fetch existing messages
  fetch(`/messages/api/conversation/${conversationId}/messages/`).then(r=>r.json()).then(data=>{
    data.messages.forEach(addMessage);
  });

  const wsProto = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${wsProto}://${window.location.host}/ws/chat/${conversationId}/`;
  const socket = new WebSocket(wsUrl);

  socket.addEventListener('open', function() {
    console.log('WebSocket open', wsUrl);
  });

  socket.addEventListener('error', function(err){
    console.error('WebSocket error', err);
  });

  socket.onmessage = function(e){
    const data = JSON.parse(e.data);
    addMessage({ sender_id: data.sender_id, content: data.message, created_at: data.created_at });
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  document.getElementById('chat-form').addEventListener('submit', function(ev){
    ev.preventDefault();
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if(!text) return;

    // prefer websocket when open
    if (socket && socket.readyState === 1) {
      socket.send(JSON.stringify({ message: text }));
      input.value = '';
      return;
    }

    // fallback to HTTP POST
    const csrftoken = getCookie('csrftoken');
    fetch(`/messages/api/conversation/${conversationId}/send/`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrftoken || ''
      },
      body: `message=${encodeURIComponent(text)}`
    }).then(r=>r.json()).then(data=>{
      if (data.message) {
        addMessage({ sender_id: data.message.sender_id, content: data.message.content, created_at: data.message.created_at });
      }
    }).catch(err=>console.error('Send fallback failed', err));

    input.value = '';
  });
</script>
{% endblock %}
