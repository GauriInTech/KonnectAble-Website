{% extends "base.html" %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/posts.css' %}">
{% endblock %}
{%extends "base.html" %}
{% block content %}
<body>
    

    <div class="container">
        <!-- CREATE POST FORM -->
        <div class="create-post">
            <div class="create-post-header">
                <div class="avatar-circle">
                    {{ request.user.username|first|upper }}
                </div>
                <span>Start a post</span>
            </div>

            <form method="post" action="" enctype="multipart/form-data">
                {% csrf_token %}
                <textarea name="content" rows="3" placeholder="Share your thoughts..."></textarea>
                <input type="file" name="image" accept="image/*">
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                    <button type="submit" class="main-btn">Post</button>
                </div>
            </form>
        </div>

        <!-- POSTS FEED -->
        {% for post in posts %}
            <div class="post-card">
                <div class="post-header">
                    <span>{{ post.user.username }}</span>
                    <span class="post-time">{{ post.created_at|timesince }} ago</span>
                </div>

                <div style="margin:15px 0;">
                    <p>{{ post.content }}</p>
                    {% if post.image %}
                        <div style="margin-top:10px;">
                            <img src="{{ post.image.url }}" alt="Post image" style="max-width:100%; border-radius:8px;">
                        </div>
                    {% endif %}
                </div>

                <div class="post-actions">
                    <!-- LIKE -->
                    <form method="post" action="/posts/like/{{ post.id }}/">
                        {% csrf_token %}
                        <button
                            type="button"
                            class="action-btn like-btn"
                            data-post-id="{{ post.id }}"
                        >
                            üëç Like ({{ post.like_set.count }})
                        </button>
                    </form>

                    <!-- COMMENT -->
                    <a href="#comment-form-{{ post.id }}" class="action-btn"
                       style="text-decoration:none; display:inline-block; text-align:center;">
                        üí¨ Comment
                    </a>

                    <!-- ‚úÖ DELETE BUTTON -->
                    {% if post.user == request.user %}
                        <form method="post" action="/posts/delete/{{ post.id }}/" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit"
                                    class="action-btn"
                                    onclick="return confirm('Delete this post?')"
                                    style="color:#e74c3c;">
                                üóëÔ∏è Delete
                            </button>
                        </form>
                    {% endif %}
                </div>

                <!-- COMMENT FORM -->
                <div id="comment-form-{{ post.id }}" class="comment-form">
                    <form method="post" action="/posts/comment/{{ post.id }}/">
                        {% csrf_token %}
                        <textarea name="text" rows="2" placeholder="Write a comment..." style="width:100%;"></textarea>
                        <button type="submit" class="main-btn" style="margin-top:8px;">Comment</button>
                    </form>
                </div>

                <!-- SHOW COMMENTS -->
                {% for comment in post.comments.all %}
                    <div style="margin-top:10px; padding:10px; background:#f9f9f9; border-radius:6px;">
                        <strong>{{ comment.author_name }}</strong>
                        <span style="font-size:12px; color:#666;">{{ comment.created_at|timesince }} ago</span>
                        <p style="margin:5px 0 0 0;">{{ comment.text }}</p>
                    </div>
                {% endfor %}
            </div>
        {% empty %}
            <p style="text-align:center; color:#666;">No posts yet. Create the first one!</p>
        {% endfor %}
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.querySelectorAll('.like-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            const postId = this.dataset.postId;

            fetch(`/posts/like/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                this.textContent = `üëç Like (${data.likes_count})`;
            })
            .catch(err => console.error(err));
        });
    });
});
</script>

</body>
</html>
{% endblock %}